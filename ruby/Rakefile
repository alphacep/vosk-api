# frozen_string_literal: true

require "bundler/gem_tasks"
require "rspec/core/rake_task"
require "rubygems/package_task"

RSpec::Core::RakeTask.new(:spec)

require "rubocop/rake_task"
require "fileutils"

RuboCop::RakeTask.new

# Figure out environment for cross-compile (same env vars as Python build)
vosk_source = ENV.fetch("VOSK_SOURCE", File.expand_path("..", __dir__))
vosk_system = ENV.fetch("VOSK_SYSTEM", nil)
vosk_machine = ENV.fetch("VOSK_MACHINE", nil)
vosk_architecture = ENV.fetch("VOSK_ARCHITECTURE", nil)

spec = Gem::Specification.load("vosk.gemspec")

if vosk_system
  # Determine gem platform (mirrors Python's get_tag logic)
  platform_string = case vosk_system
  when "Darwin"
    "universal-darwin"
  when "Windows"
    if vosk_machine == "aarch64"
      "arm64-mingw-ucrt"
    elsif vosk_architecture == "32bit"
      "x86-mingw32"
    else
      "x64-mingw32"
    end
  when "Linux"
    cpu = case vosk_machine
    when "x86_64"  then "x86_64"
    when "aarch64" then "aarch64"
    when "armv7l"  then "arm"
    when "x86"     then "x86"
    when "riscv64" then "riscv64"
    else raise "Unknown VOSK_MACHINE: #{vosk_machine}"
    end
    "#{cpu}-linux"
  else
    raise "Unknown VOSK_SYSTEM: #{vosk_system}"
  end

  spec.platform = Gem::Platform.new(platform_string)

  # Copy pre-compiled libraries (same pattern as Python setup.py)
  lib_dir = File.join(__dir__, "lib", "vosk")
  libs = Dir[File.join(vosk_source, "src", "*.{so,dll,dylib,dyld}")]
  libs.each do |lib|
    puts "Adding library #{lib}"
    FileUtils.cp(lib, lib_dir)
  end

  spec.files += Dir[File.join("lib", "vosk", "*.{so,dll,dylib,dyld}")]
end

Gem::PackageTask.new(spec).define

task default: %i[spec rubocop]
